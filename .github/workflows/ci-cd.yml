name: Full CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to EC2 Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "âœ… Switching to project directory..."
          cd /opt/app/vue-fastapi-pm2-template

          echo "âœ… Pulling latest changes from main..."
          git pull origin main

          echo "âœ… Building frontend..."
          cd frontend
          npm install
          npm run build

          echo "âœ… Restarting frontend with PM2..."
          pm2 restart pmi-frontend || pm2 start ecosystem.config.cjs

          echo "âœ… Updating backend..."
          cd ../backend
          source venv/bin/activate
          pip install -r requirements.txt

          echo "âœ… Restarting backend service..."
          sudo systemctl restart pmi-backend

          echo "ðŸŽ‰ Deployment completed successfully!"
        EOF
